<ng-template #loading>
    <h4>{{ 'COMMON.LOADING' | translate }}</h4>
</ng-template>

<ng-container *ngIf="form != null; else loading">
    <form [formGroup]="form">
        <nb-card>
            <nb-card-header>{{ 'SETTINGS.WIFI_SETTINGS' | translate }}</nb-card-header>
            <nb-card-body>
                <div class="form-row">
                    <label for="hostname" class="form-label">{{ 'SETTINGS.HOSTNAME' | translate }}:</label>
                    <div class="form-control-wrapper">
                        <input nbInput id="hostname" type="text" formControlName="hostname" />
                    </div>
                </div>
                <div class="form-row">
                    <label for="ssid" class="form-label">{{ 'SETTINGS.WIFI_SSID' | translate }}:</label>
                    <div class="form-control-wrapper">
                        <input nbInput id="ssid" type="text" formControlName="ssid" />
                    </div>
                </div>
                <div class="form-row">
                    <label for="wifiPass" class="form-label">{{ 'SETTINGS.WIFI_PASSWORD' | translate }}:</label>
                    <div class="input-with-icon">
                        <input nbInput id="wifiPass" formControlName="wifiPass"
                            [type]="showWifiPassword ? 'text' : 'password'" [placeholder]="'SETTINGS.WIFI_PASSWORD_PLACEHOLDER' | translate" />
                        <button nbButton ghost size="small" (click)="toggleWifiPasswordVisibility()" type="button"
                            class="icon-button">
                            <nb-icon [icon]="showWifiPassword ? 'eye-off-outline' : 'eye-outline'" pack="eva"></nb-icon>
                        </button>
                    </div>
                </div>
            </nb-card-body>
        </nb-card>

        <nb-tabset>
            <nb-tab [tabTitle]="'SETTINGS.PRIMARY_STRATUM_POOL' | translate">
                <nb-card-body>
                    <div class="form-row">
                        <label for="stratumURL" class="form-label">{{ 'SETTINGS.STRATUM_HOST' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input nbInput id="stratumURL" type="text" formControlName="stratumURL" /><br />
                            <small>{{ 'SETTINGS.STRATUM_HOST_HINT' | translate }}</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="stratumPort" class="form-label">{{ 'SETTINGS.STRATUM_PORT' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input nbInput id="stratumPort" formControlName="stratumPort" type="number" />
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="stratumUser" class="form-label">{{ 'SETTINGS.STRATUM_USER' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input nbInput id="stratumUser" formControlName="stratumUser" type="text" />
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="stratumPassword" class="form-label">{{ 'SETTINGS.STRATUM_PASSWORD' | translate }}:</label>
                        <div class="input-with-icon">
                            <input nbInput id="stratumPassword" formControlName="stratumPassword"
                                [type]="showStratumPassword ? 'text' : 'password'"
                                placeholder="Enter stratum password" />
                            <button nbButton ghost (click)="toggleStratumPasswordVisibility()" type="button"
                                class="icon-button">
                                <nb-icon [icon]="showStratumPassword ? 'eye-off-outline' : 'eye-outline'"
                                    pack="eva"></nb-icon>
                            </button>
                        </div>
                    </div>
                    <div class="form-row">
                        <nb-checkbox formControlName="stratumEnonceSubscribe">{{ 'MINING.ENABLE_EXTRANONCE' | translate }}</nb-checkbox>
                    </div>
                </nb-card-body>
            </nb-tab>

            <nb-tab [tabTitle]="'SETTINGS.FALLBACK_STRATUM_POOL' | translate">
                <nb-card-body>
                    <div class="form-row">
                        <label for="fallbackStratumURL" class="form-label">{{ 'SETTINGS.STRATUM_HOST' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input nbInput id="fallbackStratumURL" type="text"
                                formControlName="fallbackStratumURL" /><br />
                            <small>{{ 'SETTINGS.STRATUM_HOST_HINT' | translate }}</small>
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="fallbackStratumPort" class="form-label">{{ 'SETTINGS.STRATUM_PORT' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input nbInput id="fallbackStratumPort" formControlName="fallbackStratumPort"
                                type="number" />
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="fallbackStratumUser" class="form-label">{{ 'SETTINGS.STRATUM_USER' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input nbInput id="fallbackStratumUser" formControlName="fallbackStratumUser" type="text" />
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="fallbackStratumPassword" class="form-label">{{ 'SETTINGS.STRATUM_PASSWORD' | translate }}:</label>
                        <div class="input-with-icon">
                            <input nbInput id="fallbackStratumPassword" formControlName="fallbackStratumPassword"
                                [type]="showFallbackStratumPassword ? 'text' : 'password'"
                                placeholder="Enter stratum password" />
                            <button nbButton ghost (click)="toggleFallbackStratumPasswordVisibility()" type="button"
                                class="icon-button">
                                <nb-icon [icon]="showFallbackStratumPassword ? 'eye-off-outline' : 'eye-outline'"
                                    pack="eva"></nb-icon>
                            </button>
                        </div>
                    </div>
                    <div class="form-row">
                        <nb-checkbox formControlName="fallbackStratumEnonceSubscribe">{{ 'MINING.ENABLE_EXTRANONCE' | translate }}</nb-checkbox>
                    </div>
                </nb-card-body>
            </nb-tab>
        </nb-tabset>

        <nb-card>
            <nb-card-header>
                <div class="d-flex align-items-center justify-content-between mt-2">
                    <div>{{ 'SETTINGS.MINING_SETTINGS' | translate }}</div>
                    <div><app-advanced-toggle (advancedToggled)="setDevToolsOpen($event)"></app-advanced-toggle></div>
                </div>
            </nb-card-header>
            <nb-card-body>
                <ng-container *ngIf="supportLevel === 0">
                    <div class="form-row">
                        <label for="frequency" class="form-label">{{ 'SETTINGS.FREQUENCY' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <nb-select formControlName="frequency" [ngClass]="{'unsafe-setting': isFrequencyTooHigh()}">
                                <nb-option *ngFor="let option of frequencyOptions" [value]="option.value">{{ option.name
                                    }}</nb-option>
                            </nb-select>
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="coreVoltage" class="form-label">{{ 'SETTINGS.CORE_VOLTAGE' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <nb-select formControlName="coreVoltage" [ngClass]="{'unsafe-setting': isVoltageTooHigh()}">
                                <nb-option *ngFor="let option of voltageOptions" [value]="option.value">{{ option.name
                                    }}</nb-option>
                            </nb-select>
                        </div>
                    </div>
                </ng-container>

                <ng-container *ngIf="supportLevel >= 1">
                    <div class="form-row">
                        <label for="frequency" class="form-label">{{ 'SETTINGS.FREQUENCY' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input (input)="checkFrequencyLimit()" [ngClass]="{'unsafe-setting': isFrequencyTooHigh()}"
                                nbInput id="frequency" formControlName="frequency" type="number" />
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="coreVoltage" class="form-label">{{ 'SETTINGS.CORE_VOLTAGE' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input (input)="checkVoltageLimit()" [ngClass]="{'unsafe-setting': isVoltageTooHigh()}"
                                nbInput id="coreVoltage" formControlName="coreVoltage" type="number" />
                        </div>
                    </div>
                </ng-container>
                <ng-container *ngIf="supportLevel >= 2">
                    <div class="form-row">
                        <label for="jobInterval" class="form-label">Job Interval:</label>
                        <div class="form-control-wrapper">
                            <input nbInput id="jobInterval" formControlName="jobInterval" type="number" /><br />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-control-wrapper-no-label">
                            <small>Mining job switching time in milliseconds.</small>
                        </div>
                    </div>
                    <div class="form-row" *ngIf="defaultVrFrequency !== undefined">
                    <label for="vrFrequency" class="form-label">VR-Frequency:</label>
                    <div class="form-control-wrapper">
                        <input nbInput id="vrFrequency" formControlName="vrFrequency" type="number" /><br />
                    </div>
                    </div>
                    <div class="form-row" *ngIf="defaultVrFrequency !== undefined">
                        <div class="form-control-wrapper-no-label">
                            <small>
                            Version Rolling Frequency.<!-- (Default <b>{{ defaultVrFrequency | number:'1.3-3' }} Hz</b>).-->
                            </small>
                            <br/>
                            <small>
                            Calculated wrap-around time: <b>{{ wrapAroundTime | number:'1.2-2' }} s</b>
                            </small>
                        </div>
                    </div>
                </ng-container>
                <ng-container *ngIf="supportLevel >= 1">
                    <div class="form-row">
                        <label for="stratumDifficulty" class="form-label">{{ 'MINING.STRATUM_DIFFICULTY' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input nbInput id="stratumDifficulty" formControlName="stratumDifficulty" type="number" /><br />
                            <small>{{ 'MINING.STRATUM_DIFFICULTY_HELP' | translate }}</small>
                        </div>
                    </div>
                </ng-container>
            </nb-card-body>
        </nb-card>
        <nb-card>
            <nb-card-header>{{ 'FAN.TITLE' | translate }}</nb-card-header>
            <nb-card-body>
                <div class="form-row">
                    <label class="form-label">{{ 'FAN.CONTROLLER' | translate }}:</label>
                    <div class="form-control-wrapper">
                        <nb-select fullWidth formControlName="autofanspeed">
                            <nb-option [value]="0">{{ 'FAN.MANUAL' | translate }}</nb-option>
                            <nb-option *ngIf="form.controls['pidTargetTemp'].value != -1" [value]="2">{{ 'SETTINGS.AUTO_FAN' | translate }} (PID)</nb-option>
                        </nb-select>
                    </div>
                </div>

                <!-- Manual fan speed slider -->
                <div *ngIf="form.controls['autofanspeed'].value === 0">
                    <div class="form-row">
                        <label>{{ 'SETTINGS.FAN_SPEED' | translate }} {{ form.controls['fanspeed'].value }}%</label>
                        <div class="form-control-wrapper">
                            <div class="progress-wrap">
                                <input type="range" class="progress" formControlName="fanspeed" min="0" max="100"
                                    step="1" />
                                <div class="progress-foreground" [style.width.%]="form.controls['fanspeed'].value">
                                </div>
                            </div>
                            <small *ngIf="form.controls['fanspeed'].value < 40" style="color: red; margin-left:10px;">Danger: Could Cause
                                Overheating</small>
                            <small *ngIf="form.controls['fanspeed'].value === 100" style="color: #F2A900; margin-left:10px;">S19
                                Simulator</small>
                        </div>
                    </div>
                </div>

                <!-- PID Fan Control Settings -->
                <div *ngIf="form.controls['autofanspeed'].value === 2 && form.controls['pidTargetTemp'].value != -1">
                    <div class="form-row">
                        <label class="form-label">{{ 'SETTINGS.TARGET_TEMP' | translate }}:</label>
                        <div class="form-control-wrapper">
                            <input nbInput type="number" formControlName="pidTargetTemp" />
                        </div>
                    </div>

                    <div *ngIf="supportLevel >= 1" class="form-row-separator" style="font-weight:bold;">PID Parameters:</div>

                    <div *ngIf="supportLevel >= 1">
                        <div class="form-row">
                            <label class="form-label">PID P:</label>
                            <div class="form-control-wrapper">
                                <input nbInput type="number" formControlName="pidP" />
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">PID I:</label>
                            <div class="form-control-wrapper">
                                <input nbInput type="number" formControlName="pidI" />
                            </div>
                        </div>
                        <div class="form-row">
                            <label class="form-label">PID D:</label>
                            <div class="form-control-wrapper">
                                <input nbInput type="number" formControlName="pidD" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-row-separator">
                    <label for="overheat_temp" class="form-label">{{ 'SETTINGS.SHUTDOWN_TEMP' | translate }}:</label>
                    <div class="form-control-wrapper">
                        <input nbInput id="overheat_temp" formControlName="overheat_temp" type="number" />
                    </div>
                </div>
                <div class="form-row" *ngIf="supportLevel >= 1">
                    <nb-checkbox formControlName="autofanpolarity">{{ 'FAN.AUTODETECT_POLARITY' | translate }} <small>({{ 'FAN.AUTODETECT_RECOMMENDED' | translate }})</small></nb-checkbox>
                </div>
                <div class="form-row" *ngIf="supportLevel >= 1">
                    <nb-checkbox formControlName="invertfanpolarity">{{ 'FAN.INVERT_POLARITY' | translate }}</nb-checkbox>
                </div>

            </nb-card-body>
        </nb-card>
        <nb-card>
            <nb-card-header>{{ 'MISC.TITLE' | translate }}</nb-card-header>
            <nb-card-body>
                <div class="form-row">
                    <nb-checkbox formControlName="flipscreen">{{ 'MISC.FLIP_SCREEN' | translate }}</nb-checkbox>
                </div>
                <div class="form-row">
                    <nb-checkbox formControlName="autoscreenoff">{{ 'MISC.AUTO_SCREEN_OFF' | translate }}</nb-checkbox>
                </div>
                <div class="form-row">
                  <nb-checkbox formControlName="stratum_keep">{{ 'MISC.STRATUM_KEEPALIVE' | translate }}</nb-checkbox>
                </div>
                <div class="form-row">
                  <label class="form-label">{{ 'SETTINGS.TIME_FORMAT' | translate }}:</label>
                  <div class="form-control-wrapper">
                    <nb-select formControlName="timeFormat" placeholder="{{ 'SETTINGS.TIME_FORMAT' | translate }}">
                      <nb-option value="24h">{{ 'SETTINGS.TIME_FORMAT_24H' | translate }}</nb-option>
                      <nb-option value="12h">{{ 'SETTINGS.TIME_FORMAT_12H' | translate }}</nb-option>
                    </nb-select>
                  </div>
                </div>
            </nb-card-body>
        </nb-card>
        <div class="d-flex align-items-center justify-content-between mt-2">
            <div>
                <div class="d-flex align-items-center justify-content-between mt-2">
                    <button nbButton size="small" [disabled]="form.invalid" (click)="confirmSave(warningDialog)"
                        status="danger">
                        {{ 'COMMON.SAVE' | translate }}
                    </button>
                </div>
            </div>
            <div><button nbButton size="small" (click)="restart()" nbTooltip="'asdf'"
                    status="danger">{{ 'SYSTEM.RESTART' | translate }}</button>
            </div>

        </div>
        <div *ngIf="requiresReboot" class="mt-2 text-danger">
            <b>You must restart this device after saving for changes to take effect.</b>
        </div>
    </form>

    <ng-template #warningDialog>
        <nb-card accent="danger" style="width: 384px">
            <nb-card-header style="color: red;">{{ 'WARNINGS.UNSAFE_SETTINGS' | translate }}</nb-card-header>
            <nb-card-body>
                <p>
                    You are about to save settings that exceed the safe operating limits of your device. Proceeding with
                    these settings may result in:
                </p>
                <ul class="m-0 pl-4">
                    <li><strong>{{ 'WARNINGS.WARRANTY_VOID' | translate }}</strong></li>
                    <li><strong>{{ 'WARNINGS.HARDWARE_DAMAGE' | translate }}</strong></li>
                    <li><strong>{{ 'WARNINGS.SYSTEM_INSTABILITY' | translate }}</strong></li>
                    <li><strong>{{ 'WARNINGS.REDUCED_LIFESPAN' | translate }}</strong></li>
                    <li>{{ 'WARNINGS.UNEXPECTED_REBOOTS' | translate }}</li>
                    <li>{{ 'WARNINGS.OVERHEATING' | translate }}</li>
                    <li>{{ 'WARNINGS.POWER_CONSUMPTION' | translate }}</li>
                    <li>{{ 'WARNINGS.PERFORMANCE_ISSUES' | translate }}</li>
                    <li>⚠️ <strong>MAY SUMMON DRAGONS! 🐉🔥</strong></li>
                </ul><br />

                <p><b>Are you sure you want to proceed?</b></p>
                <p>
                    <nb-checkbox [(ngModel)]="dontShowWarning">
                        Don't show this warning again
                    </nb-checkbox>
                </p>
                <div class="d-flex justify-content-between">
                    <button nbButton status="danger" (click)="saveAfterWarning()">{{ 'WARNINGS.PROCEED_ANYWAY' | translate }}</button>
                    <button nbButton status="basic" (click)="dialogRef?.close()">{{ 'COMMON.CANCEL' | translate }}</button>
                </div>
            </nb-card-body>
        </nb-card>
    </ng-template>





</ng-container>
